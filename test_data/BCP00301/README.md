# BCP-003-01 Certificate Authority

In order to ease testing with TLS, the test suite includes a certificate authority which has been created for this sole
purpose. Typically storing private keys in a code repository would be bad practice, but in this case as the CA will not
be used in production this is not a requirement.

[This CA](ca) was generated with the assistance of <https://jamielinux.com/docs/openssl-certificate-authority>, and can be
re-generated using the './generateCA' script. Note that re-generating the CA will invalidate any existing certificates.

Please consult the guides below which indicate which keys and certificates need to be installed where, and any other
modifications which may be necessary to your system in order to use the test suite in HTTPS mode.

## Chain of Trust

In order to trust certificates generated by this CA, any device under test which communicates with the mock Node or
Registry provided by the test suite will need to load the CA's certificate into their trust store. At present this is
only required when running the IS-04 Node tests. The mechanism to install CA certificates varies by operating system.

**IMPORTANT:** Do not leave this chain of trust installed in devices once testing has been completed. Otherwise they
will continue to trust any certificates generated by the CA within this repository indefinitely.

The trusted certificate is held in the following file:
*   [certs/ca.cert.pem](ca/certs/ca.cert.pem)

## Installing Certificates

In order for requests made to the device under test to be trusted by the test suite, the following private keys and
certificates must be loaded into the device. This will provide the device with the hostname 'api.testsuite.nmos.tv',
and the hostname 'nmos-api.local' for mDNS.

**IMPORTANT:** Do not leave these private keys and certificates installed on a device once testing is complete.

Note that both an RSA and ECDSA certificate are provided in order to meet the requirements of BCP-003-01. Please consult
your TLS library or application for the configuration required in order to load two certificates at once.

The device under test should use the private keys:
*   [intermediate/private/rsa.api.testsuite.nmos.tv.key.pem](ca/intermediate/private/rsa.api.testsuite.nmos.tv.key.pem)
*   [intermediate/private/ecdsa.api.testsuite.nmos.tv.key.pem](ca/intermediate/private/ecdsa.api.testsuite.nmos.tv.key.pem)

If your device under test can use certificate chain files, please use:
*   [intermediate/certs/rsa.api.testsuite.nmos.tv.cert.chain.pem](ca/intermediate/certs/rsa.api.testsuite.nmos.tv.cert.chain.pem)
*   [intermediate/certs/ecdsa.api.testsuite.nmos.tv.cert.chain.pem](ca/intermediate/certs/ecdsa.api.testsuite.nmos.tv.cert.chain.pem)

In each case, these certificate chain files contain the server certificate and the complete chain to the CA.

Alternatively, if your web server requires the server certificate and the chain to the CA to be separate, please use each of the server certificates:
*   [intermediate/certs/rsa.api.testsuite.nmos.tv.cert.pem](ca/intermediate/certs/rsa.api.testsuite.nmos.tv.cert.pem)
*   [intermediate/certs/ecdsa.api.testsuite.nmos.tv.cert.pem](ca/intermediate/certs/ecdsa.api.testsuite.nmos.tv.cert.pem)
with the chain file:
*   [intermediate/certs/ca-chain.cert.pem](ca/intermediate/certs/ca-chain.cert.pem)

## Hosts Files

As the test suite does not have control over your default DNS server and given that testing with TLS requires the use of
hostnames, you will need to add some temporary entries to the hosts file on your machine(s) when performing testing.
The mechanism to modify hosts files varies by operating system.

On the host running the test suite, add an entry to the hosts file for 'api.testsuite.nmos.tv' pointing at the IP
address of the host under test.

On the host under test, add the following entries to the hosts file for 'mocks.testsuite.nmos.tv' and 'crl.testsuite.nmos.tv'
pointing at the IP address of the host running the test suite. At present this is only required for the IS-04 Node tests which
require that the unit under test communicate directly with entities which are 'mocked' by the test suite.

## Additional Certificates

Additional certificates can be generated using this CA if required, using the './generateCerts' script followed by a
domain name and an optional additional domain name ending in '.local' for mDNS usage.

Example: `./generateCerts myapi testsuite.nmos.tv myapi.local`

## Temporary Diffie-Hellman Parameters

When an ephemeral Diffie-Hellman cipher is used, the server and the client negotiate a pre-master key using the
Diffie-Hellman algorithm. This algorithm requires that the server sends the client a prime number and a generator.
Neither are confidential, and are sent in clear text.

The './generateDHParams' script may be used to generate appropriate parameters.

Alternatively, since they do not need to be unique or private, the server under test may use the provided file:
*   [intermediate/private/dhparam.pem](ca/intermediate/private/dhparam.pem)

This currently contains the 4096-bit DH parameters recommended by [RFC 7919](https://tools.ietf.org/html/rfc7919).

## Other Notes

CA and intermediate are valid for 50 years
CA/Intermediate CN: ca.testsuite.nmos.tv

Any web servers activated by the test suite itself should use the following private keys and certificates. These use the
hostname 'mocks.testsuite.nmos.tv', and the hostname 'nmos-mocks.local' for mDNS.
*   [intermediate/private/rsa.mocks.testsuite.nmos.tv.key.pem](ca/intermediate/private/rsa.mocks.testsuite.nmos.tv.key.pem)
*   [intermediate/private/ecdsa.mocks.testsuite.nmos.tv.key.pem](ca/intermediate/private/ecdsa.mocks.testsuite.nmos.tv.key.pem)
*   [intermediate/certs/rsa.mocks.testsuite.nmos.tv.cert.chain.pem](ca/intermediate/certs/rsa.mocks.testsuite.nmos.tv.cert.chain.pem)
*   [intermediate/certs/ecdsa.mocks.testsuite.nmos.tv.cert.chain.pem](ca/intermediate/certs/ecdsa.mocks.testsuite.nmos.tv.cert.chain.pem)
