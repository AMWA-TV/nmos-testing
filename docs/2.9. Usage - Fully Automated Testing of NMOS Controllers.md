# Testing NMOS Controllers

## Fully Automated NMOS Controller Tests

The testing tool supports fully automated testing of NMOS Controllers by replacing the Testing Façade with your own application to receive and process the requests from the NMOS Testing Tool. A full example utilising Flask and Selenium can be found on the nmos-js repository under AutomatedTesting. 

## Building your fully automated test interface

The Testing Façade IP/Hostname and Port on the test suite should be set to the location of your application.
POST requests are sent from the Test Suite to the API endpoint `{IP/hostname}:{Port}/x-nmos/testing-facade` 

The JSON schema for the Q&A protocol is as follows:
```json
{
    "title": "Client Testing Q&A protocol",
    "description": "Contains all details necessary for NMOS Controller Testing",
    "$schema": "http://json-schema.org/draft-04/schema",
    "required": [
        "test_type",
        "question_id",
        "name",
        "description",
        "question",
        "answers",
        "time_sent",
        "timeout",
        "url_for_response",
        "answer_response",
        "time_answered",
        "metadata"
    ],
    "properties": {
        "test_type": {
            "description": "String indicating the type of question being sent. ",
            "anyOf": [
                {
                    "radio": {
                        "description": "A single answer_id is expected and should be used to return a string"
                    },
                    "checkbox": {
                        "description": "Multiple answer_id's are expected and should be used to return a list of strings"
                    },
                    "action": {
                        "description": "Instructions to be carried out by the user, no answer to return"
                    }
                }

            ]
        },
        "question_id": {
            "description": "A unique string for each individual question"
        },
        "name": {
            "description": "The test name, identical to the question_id unless a test contains multiple questions"
        },
        "description": {
            "description": "String, a brief description of the test"
        },
        "question": {
            "description": "String, human readable question text containing instructions to carry out the test"
        },
        "answers": {
            "type": "array",
            "description": "Array containing answer objects to be used to select the correct answer_id to be returned.",
            "examples": [
                [
                    {
                        "answer_id": "answer_2",
                        "label": "s3/wright",
                        "description": "Mock sender 3",
                        "id": "71ce775c-cdc5-479a-bd29-87c081905ecf",
                        "answer_str": "s3/wright (Mock sender 3, 71ce775c-cdc5-479a-bd29-87c081905ecf)"
                    }
                ]
            ],
            "additionalItems": true,
            "items": {
                "anyOf": [
                    {
                        "description": "Individual answer details, the label, description and id of the relevant resource and an associated answer_id",
                        "required": [
                            "answer_id",
                            "label",
                            "description",
                            "id",
                            "answer_str"
                        ],
                        "properties": {
                            "answer_id": {
                                "description": "String, unique to each answer within a question. This is the value to be returned for validation."
                            },
                            "label": {
                                "description": "Resource label as might be displayed on the NCuT"
                            },
                            "description": {
                                "description": "Resource description as might be displayed on the NCuT"
                            },
                            "id": {
                                "description": "Resource ID as might be displayed on the NCuT"
                            },
                            "answer_str": {
                                "description": "String combining all the resource details for display on the testing facade"
                            }
                        },
                        "additionalProperties": true
                    }
                ]
            }
        },
        "time_sent": {
            "description": "Float, time the question was sent"
        },
        "timeout": {
            "description": "Float, time in seconds the test suite will wait to receive an answer to a particular question",
            "default": 600
        },
        "url_for_response": {
            "description": "URL of the test suite API endpoint to send the POST request with answers"
        },
        "answer_response": {
            "description": "Null when received. Should be filled with answer_ids or 'Next' according to question type when POSTed back to url_for_response",
            "default": "",
            "anyOf": [
                {
                    "type": null,
                    "description": "Null entry when sent from test suite"
                },
                {
                    "description": "A single answer string, for 'radio' type questions",
                    "examples": [
                        "answer_1"
                    ]
                },
                {
                    "description": "Multiple answer strings, for 'checkbox' type questions",
                    "examples": [
                        ["answer_1", "answer_5"]
                    ]
                },
                {
                    "description": "Specific string 'Next', for 'action' type questions",
                    "examples": [
                        "Next"
                    ]
                }
            ]
        },
        "time_answered": {
            "description": "Null when received. Should be filled with float string of time answered when returned",
            "default": ""
        },
        "metadata": {
            "description": "Details of Sender and Receiver where specified in the question text for IS05 tests",
            "properties": {
                "sender": {
                    "description": "Details of sender chosen to be part of IS05 connection management test",
                    "required": [
                        "id",
                        "label",
                        "description"
                    ],
                    "properties": {
                        "id": {
                            "description": "ID of sender as might be shown on NCut"
                        },
                        "label": {
                            "description": "Label of sender as might be shown on NCuT"
                        },
                        "description": {
                            "description": "Description of sender as might be shown on NCuT"
                        }
                    }
                },
                "receiver": {
                    "description": "Details of receiver chosen to be part of IS05 connection maagement test",
                    "required": [
                        "id",
                        "label",
                        "description"
                    ],
                    "properties": {
                        "id": {
                            "description": "ID of receiver as might be shown on NCuT"
                        },
                        "label": {
                            "description": "Label of receiver as might be shown on NCuT"
                        },
                        "description": {
                            "description": "Description of receiver as might be shown on NCuT"
                        }
                    }
                }
            }
        }
    }
}
```
Example POST request from test suite to `/x-nmos/testing-facade`:
```json
{
    "test_type": "radio",
    "question_id": "test_05_1",
    "name": "test_05",
    "description": "Reference Sender is put offline and then back online",
    "question": "Please refresh your NCuT and select the sender which has been put 'offline'",
    "answers": [
        {
            "answer_id": "answer_2",
            "label": "s3/wright",
            "description": "Mock sender 3",
            "id": "71ce775c-cdc5-479a-bd29-87c081905ecf",
            "answer_str": "s3/wright (Mock sender 3, 71ce775c-cdc5-479a-bd29-87c081905ecf)"
        },
        {
            "answer_id": "answer_3",
            "label": "s4/mason",
            "description": "Mock sender 4",
            "id": "14db3fcd-3606-4679-9c2a-252b4af1e611",
            "answer_str": "s4/mason (Mock sender 4, 14db3fcd-3606-4679-9c2a-252b4af1e611)"
        },
        {
            "answer_id": "answer_4",
            "label": "s5/barrett",
            "description": "Mock sender 5",
            "id": "b0a5f961-21de-4ec7-951e-58bbea8934f3",
            "answer_str": "s5/barrett (Mock sender 5, b0a5f961-21de-4ec7-951e-58bbea8934f3)"
        }
    ],
    "time_sent": 1630580530.0981488,
    "timeout": 600,
    "url_for_response": "http://127.0.0.1:5000/testingfacade_response",
    "answer_response": "",
    "time_answered": "",
    "metadata": null
}
```
Example POST request from Test Suite to `/x-nmos/testing-facade` including metadata:
```json
{
    "test_type": "action",
    "question_id": "test_07",
    "name": "test_07",
    "description": "Instruct Receiver to subscribe to a Sender’s Flow via IS-05",
    "question": "All flows that are available in a Sender should be able to be connected to a Receiver. Use the NCuT to perform an 'immediate' activation between sender: s5/barrett (Mock sender 5, 490dc37e-eb1c-45f8-ac1c-364f15335d49) and receiver:r6/gilliam (Mock receiver 6, f3a243b0-3699-409b-ae1d-e260e2a29e2f) Click the 'Next' button once the connection is active.",
    "answers": [],
    "time_sent": 1630658951.439078,
    "timeout": 600,
    "url_for_response": "http://127.0.0.1:5000/testingfacade_response",
    "answer_response": "",
    "time_answered": "",
    "metadata": {
        "sender": {
            "id": "490dc37e-eb1c-45f8-ac1c-364f15335d49",
            "label": "s5/barrett",
            "description": "Mock sender 5"
        },
        "receiver": {
            "id": "f3a243b0-3699-409b-ae1d-e260e2a29e2f",
            "label": "r6/gilliam",
            "description": "Mock receiver 6"
        }
    }
}
```

An example class for storing and retrieving this data can be found at `testingfacade/DataStore.py`

On receiving a POST request from the Testing Tool, your application should use the question id to instruct your chosen automated test framework (eg. Selenium) to carry out the required tasks on your Controller and return appropriate answers.

Some test have multiple questions, all of which must be answered correctly to pass the test. 

There are three types of question that requires different answer formats:
- Radio - return a single answer string of the answer_id from the answers dict
- Checkbox - return multiple answer strings of answer_id's from the answers dict in a list
- Action - no answers given, return the string 'Next' once the required actions have been completed

Your application should POST the answer(s) to the url given in `url_for_response`. This POST request should contain the entire json response originally received from the test suite with your answer(s) in the `answer_response` field and the current time in the `time_answered` field. 

Example answer POST request from your application to `url_for_response`:
```json
{
    "test_type": "radio",
    "question_id": "test_09",
    "name": "test_09",
    "description": "Indicating the state of connections via updates received from the IS-04 Query API",
    "question": "The NCuT should be able to monitor and update the connection status of all registered Devices. Use the NCuT to identify the receiver that has just been connected.",
    "answers": [{
        "answer_id": "answer_0",
        "label": "r5/idle",
        "description": "Mock receiver 5",
        "id": "b7d4d089-96e4-4833-b77e-643a7738b899",
        "answer_str": "r5/idle (Mock receiver 5, b7d4d089-96e4-4833-b77e-643a7738b899)"
    }, {
        "answer_id": "answer_1",
        "label": "r6/gilliam",
        "description": "Mock receiver 6",
        "id": "f3a243b0-3699-409b-ae1d-e260e2a29e2f",
        "answer_str": "r6/gilliam (Mock receiver 6, f3a243b0-3699-409b-ae1d-e260e2a29e2f)"
    }],
    "time_sent": 1630658996.6167943,
    "timeout": 600,
    "url_for_response": "http://127.0.0.1:5000/testingfacade_response",
    "answer_response": "answer_1",
    "time_answered": 1630659011.1048524,
    "metadata": null
}
```

The test suite will process the answer then send the next question. If no answer is received by the test suite within the timeout period, the test will expire and the first question of the next test will be sent.

The test suite begins with a pre_tests_message and ends with a post_tests_message. These should be treated as action questions and return 'Next' to begin/end the actual tests.
