## Usage

Provide the URL of the relevant API under test (see the detailed description on the webpage) and select a test suite from the checklist. The result of the tests will be shown after a few seconds.

The result of each test case will be one of the following:

| Pass | Reason |
| - | - |
| ![Pass](https://place-hold.it/128x32/28a745.png?text=Pass&fontsize=12&bold) | Successful test case. |
| ![Fail](https://place-hold.it/128x32/dc3545.png?text=Fail&fontsize=12&bold) | Required feature of the specification has been found to be implemented incorrectly. |
| ![Warning](https://place-hold.it/128x32/ffc107.png?text=Warning&fontsize=12&bold) | Not a failure, but the API being tested is responding or configured in a way which is not recommended in most cases. |
| ![Test Disabled](https://place-hold.it/128x32/ffc107.png?text=Test%20Disabled&fontsize=12&bold) | Test is disabled due to test suite configuration; change the config or test manually. |
| ![Could Not Test](https://place-hold.it/128x32/ffc107.png?text=Could%20Not%20Test&fontsize=12&bold) | Test was not run due to prior responses from the API, which may be OK, or indicate a fault. |
| ![Not Implemented](https://place-hold.it/128x32/ffc107.png?text=Not%20Implemented&fontsize=12&bold) | Recommended/optional feature of the specifications has been found to be not implemented. |
| ![Manual](https://place-hold.it/128x32/007bff.png?text=Manual&fontsize=12&bold) | Test suite does not currently test this feature, so it must be tested manually. |
| ![Not Applicable](https://place-hold.it/128x32/6c757d.png?text=Not%20Applicable&fontsize=12&bold) | Test is not applicable, e.g. due to the version of the specification being tested. |

### Testing Unicast discovery

In order to test unicast discovery, the test suite launches its own mock DNS server which your Node will need to be pointing at in order to correctly discover the mock registries. The following steps should be completed to operate in this mode:

*   Ensure the `DNS_SD_MODE` in the test tool's `nmostesting/Config.py` file is set to `'unicast'` before running the testing tool.
*   Configure the DNS search domain for your Node to be `testsuite.nmos.tv` (either manually or by providing this to your Node via DHCP).
*   Configure the DNS server IP address for your Node to be the IP address of the host which is running the testing tool (either manually or by providing this to your Node via DHCP).

Unicast DNS advertisements for registries only become available once tests are running. As a result the unit under test may need prompting to re-scan the DNS server for records at this point. The `TEST_START_DELAY` config parameter may be used to increase the period which the test suite waits for in this situation.

If your network requires the use of the proxy server, you may find it necessary to disable this configuration on the host running the test suite and on the unit under test when using unicast DNS. This is because any requests to fully qualified hostnames are likely to be directed to your proxy server, which will be unable to resolve them.

### Testing BCP-003-01 TLS

Testing of certain aspects of BCP-003-01 makes use of an external tool 'testssl.sh'. Please see [testssl/README.md](testssl/README.md) for installation instructions.

In order to ease testing of TLS with the various specifications, sample certificates are provided in this repository. Please see [test_data/BCP00301/README.md](test_data/BCP00301/README.md) for their details and installation guidance.

### Testing IS-10 Authorization

When testing IS-10 / BCP-003-02 implementations, ensure that a user is registered with the Authorization Server with a
username and password that corresponds with the `AUTH_USERNAME` and `AUTH_PASSWORD` config options in the
`nmostesting/Config.py` file. These values should be changed to sensible values before running the IS-10 tests
and will be used as the Basic Authentication mechanism when contacting the Authorization Server.

When testing dynamic client registration, the contents of `/test_data/IS1001/register_client_request_data.json` will be used in
the body of the request when registering the client, and should comply with [RFC7591](https://tools.ietf.org/html/rfc7591). When
testing the authorization code grant, the means by which consent is given by the resource owner will be implementation-specific.
The contents of the file `/test_data/IS1001/authorization_request_data.json` will be used as the body of the request to the
authorization endpoint. **Please edit both files** to comply with the implementation under test.

### Testing of SDP files

IS-05 test_41 checks that SDP files conform to the expectations of ST.2110. In order to enable these tests, please ensure that [SDPoker](https://github.com/Streampunk/sdpoker) is available on your system.

### Non-Interactive Mode

The test suite supports non-interactive operation in order use it within continuous integration systems. An example of this usage can be seen below:

```shell
# List the available test suites
python3 nmos-test.py --list-suites

# List the available tests for a given test suite
python3 nmos-test.py suite IS-04-02 --list-tests

# Run just the 'auto' tests for the given suite, saving the output as a JUnit XML file
python3 nmos-test.py suite IS-04-02 --selection auto --host 128.66.12.5 128.66.12.6 --port 80 80 --version v1.2 v1.2 --ignore auto_5 auto_6 --output results.xml
```

To display additional information about the available command-line options:

```shell
# Show the usage
python3 nmos-test.py -h

# Show the specific options for the 'suite' command
python3 nmos-test.py suite -h
```

### Using the API

The testing tool comes with a minimal API for running tests remotely and configuring the testing tool instance dynamically.
This is particularly useful for automated testing purposes. The two endpoints presented by the API are:
- `/api` [GET, POST] - this is the primary endpoint for executing tests.
- `/config` [GET, PATCH] - this endpoint returns the current config and allows dynamic configuration of the testing tool.

#### `/api`
_[GET, POST]_

This endpoint accepts (almost) identical inputs as the non-interactive command line utility, except hyphens (-) are replaced with underscores (\_) for key values.

- GET - Example page
- POST - Perform a test for a remote host or list the set of test-suites / tests within a suite.

For a list of test suites, the body of the POST request would be:

```json
{
  "list_suites": true
}
```

To execute a test for a remote API, the body of the POST request would look something like:

```json
{
  "suite": "IS-05-01",
  "host": ["192.168.1.2"],
  "port": [80],
  "version": ["v1.0"]
}
```

**NOTE**: Much like in non-interactive mode, the testing tool is currently limited to running a _single test suite at a time_.

#### `/config`
_[GET, PATCH]_

- GET - render the current loaded config.
- PATCH - alter the running config.

To change the testing tool from using HTTP to using HTTPS, the body of the request would be:

```json
{
  "ENABLE_HTTPS": true
}
```

**NOTE**:
- Changes to the `ENABLE_HTTPS` flag via the API will not configure the Testing Tool's Flask instances correctly for use with
TLS. This specifically affects the IS-04 test suites. For changes to this parameter, it is advised the Config.py file is
changed and the service restarted.
- Changes to the `DNS_SD_MODE` parameter via the API to `unicast` will currently not work as expected. For changes to this
parameter, it is advised the Config.py file is changed and the service restarted.

## External Dependencies

*   Python 3
*   Git
*   [testssl.sh](https://testssl.sh) (required for BCP-003-01 testing)
*   [OpenSSL](https://www.openssl.org/) (required for BCP-003-01 OCSP testing)
*   libssl-dev (Linux users only, required for IS-10 testing)
*   [SDPoker](https://github.com/Streampunk/sdpoker) (required for IS-05 SDP testing)
*   See [requirements.txt](requirements.txt) for additional packages

## Additional Documentation

Some of the tests contained within this tool perform a number of steps which may not be obvious without viewing the source code. Descriptions of complex tests' behaviour is documented in [docs/](docs/README.md) in order to aid with debugging.

