# Testing NMOS Controllers

## Running the Semi-automatic NMOS Controller Tests

Launch the Testing Façade from the testingfacade directory. By default the Testing Façade will run on port 5001
```shell
python3 TestingFacade.py
```

Launch the NMOS Testing tool in the usual way.

In the NMOS Testing Tool select 'NMOS Controller' tests and configure the IP/Hostname to that of the machine running the Testing Façade (e.g. localhost) and the Port to the Testing Façade's port (use 5001 by default).

Select and launch the tests from the NMOS Testing tool, and follow the instructions displayed on the Testing Façade.

### Known Issues

* The "auto" test selection, although present, doesn't do anything presently as there is no RAML associated with the NMOS Controller tests.
* The Mock Registry is currently open to registrations from any NMOS Node. Therefore NMOS Nodes on your network searching for a Registry are likely to register with the Mock Registry.

## Test Suite Overview
The IS-04 NMOS Controller (IS-04-04) and IS-05 NMOS Controller (IS-05-03) test suites map the tests described in Sections 7 and 8 of the [JT-NM Tested March 2020 AMWA NMOS / JT-NM TR-1001-1 Media Nodes, Registries, Controllers Results Catalog](https://static.jt-nm.org/documents/JT-NM_Tested_Catalog_NMOS-TR-1001_Full-Online-2020-05-12.pdf).

The following is a short description of each of the tests, and the expected behaviour of the NMOS Controller under test (NCuT).

## Pre Tests Message
### Description
In order to give the tests some context, a pre tests message is displayed on the Testing Façade prior to the tests starting. 
This communicates any pre-requisites or setup required by the Test User. 
The pre tests message will vary depending on whether or not DNS-SD is being used to discover the mock Registry. 

### Test User Action

If the NCuT is using DNS-SD to find the mock Registry:
* Ensure the DNS_SD_MODE in the testing tool's nmostesting/UserConfig.py file is set to 'unicast' before running the tool. This will require the Testing Tool being restarted with root/administrator privileges.
* Configure the DNS search domain for your NCuT to be testsuite.nmos.tv (either manually or by providing this to your NCuT via DHCP).
* Configure the DNS server IP address for your NCuT to be the IP address of the host which is running the testing tool (either manually or by providing this to your NCuT via DHCP).
* Unicast DNS advertisements for the mock Registry only becomes available once the test suite is running. As a result the NCuT may need prompting to re-scan the DNS server for records at this point.
* If your network requires the use of the proxy server, you may find it necessary to disable this configuration on the host running the testing tool and on the NCuT under test when using unicast DNS. This is because any requests to fully qualified hostnames are likely to be directed to your proxy server, which will be unable to resolve them.
* On Testing Façade: Once configured click the ‘Next’ button to start the tests.

If the NCuT is NOT using DNS-SD to find the mock Registry:
* On NCuT: Manually configure the mock Registry.
* On Testing Façade: Click the ‘Next’ button.

## IS-04 NMOS Controller Tests
### Test_01: Ensure NCuT uses DNS-SD to find registry
#### Description
The NCuT shall use unicast DNS Service Discovery (DNS-SD) to locate the mock Registry. 
A DHCP server will provide all the connection details to discover the mock Registry.

#### Test User Action
* This test is executed in the background and requires no user action.

#### Pass Criteria
* The mock DNS server has been contacted by the NCuT.

### Test_02: Ensure NCuT can access the IS-04 Query API

#### Description
The NCuT shall use the mock Registry’s IS-04 Query API either via the REST API or by requesting websocket subscriptions.

#### Test User Action
* *On NCuT:* Browse the Senders and Receivers on the mock Registry via the IS-04 Query API.
* *On Testing Façade:* Click the 'Next' button. 

#### Pass Criteria
* The NCuT has exercised either the mock Registry’s REST Query API and/or requested QueryAPI websocket subscriptions.

### Test_03: Query API should be able to discover all the Senders that are registered in the Registry
#### Description
The NCuT shall use the mock Registry’s IS-04 Query API to discover all the Senders that are registered in the mock Registry. If using the RESTful API rather than WebSockets, Pagination must be implemented.

#### Test User Action
* *On NCuT:* If necessary, refresh the view and check every available page.
* *On Testing Façade:* Select all the Senders that are available from the presented list (multiple choice checkboxes).
* *On Testing Façade:* Click the ‘Submit’ button.

#### Pass Criteria
* The Test User has selected the correct Senders.

### Test_04: Query API should be able to discover all the Receivers that are registered in the Registry
#### Description
The NCuT shall use the mock Registry’s IS-04 Query API to discover all the Receivers that are registered in the mock Registry. If using the RESTful API rather than WebSockets, Pagination must be implemented.

#### Test User Action
* *On NCuT:* If necessary, refresh the view and check every available page.
* *On Testing Façade:* Select all the Receivers that are available from the presented list (multiple choice checkboxes).
* *On Testing Façade:* Click the ‘Submit’ button.

#### Pass Criteria
* The Test User has selected the correct Receivers.

### Test_05: Reference Sender is put offline then back online
#### Description
The NCuT shall discover and dynamically update all the Senders that are registered in the Registry. 
* Use the NCuT to browse and take note of the Senders that are available.
* After the ‘Next’ button has been clicked one of those Senders will be put ‘offline’.
* The Sender which was put ‘offline’ will then come back online at a random moment within the following 60 seconds. 
* As soon as the NCuT detects the Sender has come back online the user must press the 'Next' button on the Testing Façade.
* The button must be pressed within 30 seconds of the Sender being put back ‘online’. This includes any latency between the Sender being put ‘online’ and the NCuT updating.

#### Test User Action
* *On Testing Façade:* Click the ‘Next’ button.
* *On NCuT:* If necessary, refresh the view.
* *On Testing Façade:* Select the Sender which has been put ‘offline’ and click the 'Submit' button.
* *On Testing Façade:* Once the Sender comes back ‘online’ click the ‘Next’ button.

#### Pass Criteria
* The Sender put ‘offline’ is the same as the Test User choice.
* The ‘Next’ button has been clicked no more than 30 seconds after ‘offline’ Sender comes back ‘online’.

## IS-05 NMOS Controller Tests
### Test_01: Identify which Receiver devices are controllable via IS-05
#### Description
The NCuT shall identify which of the discovered Receivers are controllable via IS-05, for instance, allowing Senders to be connected. 
* The Testing Tool registers additional Receivers with the mock Registry, a subset of which have a connection API.
* The Test User refreshes the NCuT and selects the Receivers that have a connection API from the provided list.
* Some NCuTs only display those Receivers which have a connection API, therefore some of the Receivers in the provided list may not be visible.

#### Test User Action
* *On NCuT:* If necessary, refresh the view.
* *On Testing Façade:* Select all the Receivers from the provided list that have an IS-05 Connection API (multiple choice checkboxes).
* *On Testing Façade:* Click the ‘Submit’ button.

#### Pass Criteria
* All the Receivers with IS-05 Connection APIs are selected.

### Test_02: Instruct Receiver to subscribe to a Sender’s Flow via IS-05
#### Description
The NCuT shall allow all flows that are available in a Sender to be connected to a Receiver.
* The Test User is prompted to perform an immediate activation between a specified Sender and Receiver.

#### Test User Action
* *On NCuT:* Perform an 'immediate' activation between the Sender and Receiver indicated on Testing Façade.
* *On Testing Façade:* Once the connection is active Click the 'Next' button.

#### Pass Criteria
* The mock Receiver has received the correct IS-05 PATCH request.

### Test_03: Disconnecting a Receiver from a connected Flow via IS-05
#### Description
The NCuT shall allow removal of active connections via the IS-05 API. 
* The Testing Tool activates a connection between a Sender and a Receiver.
* The Test User is asked to perform an immediate deactivation on this connection.

#### Test User Action
* *On NCuT:* Deactivate the connection between the Sender and Receiver indicated by the Testing Façade.
* *On Testing Façade:* Once the connection has been deactivated click the 'Next' button .

#### Pass Criteria
* The mock Receiver has received the correct IS-05 PATCH request.

### Test_04: Indicating the state of connections via updates received from the IS-04 Query API
#### Description
The NCuT shall monitor and update the connection status of all registered Devices. 
This test seeks to validate the NCuT’s ability to monitor connections that are made between Senders and Receivers outside of the NCuT’s control.
* A connection to a Receiver is activated. 
* The Test User is asked to identify this Receiver.  
* The Test User is asked to identify the Sender connected to the Receiver. 
* The Receiver connection is deactivated in the background by the Testing Tool within the following 60 seconds. 
* As soon as the NCuT detects the Receiver has been deactivated the Test User must press the 'Next' button.
* The button must be pressed within 30 seconds of the Receiver connection being deactivated. This includes any latency between the Receiver connection being deactivated and the NCuT updating.

#### Test User Action
* *On Testing Façade:* Select the Receiver on which the connection that has just been activated (multiple choice radio button).
* *On Testing Façade:* Click the ‘Submit’ button.
* *On Testing Façade:* Select the Sender currently connected to that Receiver.
* *On Testing Façade:* Click the ‘Submit’ button.
* *On Testing Façade:* Once the Receiver connection deactivates click the ‘Next’ button.

#### Pass Criteria
* The Receiver on which the connection has been activated is correctly identified.
* The connected Sender is correctly identified.
* The ‘Next’ button has been clicked no more than 30 seconds after the Receiver connection is deactivated.

## Post Tests Message
### Description
Once the tests are complete a post tests message is displayed.

### User Action
* *On Testing Façade:*  Click the ‘Next’ button to finish tests.