# Testing NMOS Controllers

## Running the Semi-automatic NMOS Controller Tests

Launch the Testing Façade from the testingfacade directory. By default the Testing Façade will run on port 5001
```shell
python3 TestingFacade.py
```

Launch the NMOS Testing tool in the usual way.

In the NMOS Testing Tool select 'NMOS Controller' tests and configure the IP/Hostname to that of the machine running the Testing Façade (e.g. localhost) and the Port to the Testing Façade's port (use 5001 by default)

Select and launch the tests from the NMOS Testing tool, and follow the instructions displayed on the Testing Façade.

### Known Issues

* The "auto" test selection, although present, doesn't do anything presently as there is no RAML associated with the NMOS Contoller tests.
* The Mock Registry is currently open to registrations from any NMOS Node. Therefore NMOS Nodes on your network searching for a Registry are likely to register with the Mock Registry.

## Test Suite Overview
The NC-01 NMOS Controller test suite maps the tests described in Sections 7 and 8 of the [JT-NM Tested March 2020 AMWA NMOS / JT-NM TR-1001-1 Media Nodes, Registries, Controllers Results Catalog](https://static.jt-nm.org/documents/JT-NM_Tested_Catalog_NMOS-TR-1001_Full-Online-2020-05-12.pdf), to semi-automated tests to be run as part of the NMOS Testing tool.

The following is a short description of each of the tests, and the expected behaviour of the NMOS Controller under test (NCuT)

### Pre Tests Message
#### Description
In order to give the tests some context a pre tests message is displayed prior to the tests starting.  This will communicate any pre-requisites or setup required by the Test User. This pre tests message will vary depending on whether DNS-SD is being used to discover the mock Registry: 

#### User Action

If the NCuT is using DNS-SD to find the mock Registry:
* Ensure the DNS_SD_MODE in the testing tool's nmostesting/UserConfig.py file is set to 'unicast' before running the tool. This will require the testing tool being restarted with root/administrator privileges.
* Configure the DNS search domain for your NCuT to be testsuite.nmos.tv (either manually or by providing this to your NCuT via DHCP).
* Configure the DNS server IP address for your NCuT to be the IP address of the host which is running the testing tool (either manually or by providing this to your NCuT via DHCP).
* Unicast DNS advertisements for registries only become available once tests are running. As a result the NCuT may need prompting to re-scan the DNS server for records at this point.
* If your network requires the use of the proxy server, you may find it necessary to disable this configuration on the host running the testing tool and on the NCuT under test when using unicast DNS. This is because any requests to fully qualified hostnames are likely to be directed to your proxy server, which will be unable to resolve them.
* On Once configured click the ‘Next’ button on the Testing Façade to start the tests.

If the NCuT is NOT using DNS-SD to find the mock Registry:
* Manually configure the mock Registry in the NCuT
* Click the ‘Next’ button

### Test_01: Ensure NCuT uses DNS-SD to find registry
#### Description
The NCuT shall use unicast DNS Service Discovery (DNS-SD) to locate the mock Registry. 
A DHCP server will provide all the connection details to discover the mock Registry.

#### User Action
* This test is executed in the background and requires no user interaction.

#### Pass Criteria
* The mock DNS server has been contacted by the NCuT

### Test_02: Ensure NCuT can access the IS-04 Query API

#### Description
The NCuT shall use the mock Registry’s QueryAPI either via the REST API or by requesting websocket subscriptions.

#### User Action
* Use the NCuT to browse the Senders and Receivers on the discovered Registry via the selected IS-04 Query API.
* Click the 'Next' button. 

#### Pass Criteria
* The NCuT has exercised either the mock Registry’s REST Query API and/or requested QueryAPI websocket subscriptions.

### Test_03: Query API should be able to discover all the Senders that are registered in the Registry
#### Description
The Query API shall discover all the Senders that are registered in the mock Registry. If using the RESTful API rather than WebSockets, Pagination must be implemented.

#### User Action
* Refresh the NCuT's view of the mock Registry and select all the Senders that are available from the presented list (multiple choice checkboxes)
* Click the ‘Next’ button.

#### Pass Criteria
* The correct Senders have been selected.

### Test_04: Query API should be able to discover all the Receivers that are registered in the Registry
#### Description
The Query API shall discover all the Receivers that are registered in the mock Registry. If using the RESTful API rather than WebSockets, Pagination must be implemented.

#### User Action
* Refresh the NCuT's view of the mock Registry and select all the Receivers that are available from the presented list (multiple choice checkboxes)
* Click the ‘Next’ button.

#### Pass Criteria
* The correct Receivers have been selected.

### Test_05: Reference Sender is put offline then back online
#### Description
The NCuT should be able to discover and dynamically update all the Senders that are registered in the Registry. 
* Use the NCuT to browse and take note of the Senders that are available.
* After the ‘Next’ button has been clicked one of those Senders will be put ‘offline’.
* The Sender which was put ‘offline’ will then come back online at a random moment within the following 60 seconds. 
* As soon as the NCuT detects the Sender has come back online the user must press the 'Next' button.
* The button must be pressed within 30 seconds of the Sender being put back ‘online’. This includes any latency between the Sender being put ‘online’ and the NCuT updating.

#### User Action
* Click the ‘Next’ button.
* Refresh the NCuT and select the Sender which has been put ‘offline’.
* Click the ‘Next’ button when the Sender comes back ‘online’.

#### Pass Criteria
* The Sender put ‘offline’ is the same as the Test User choice.
* The ‘Next’ button has been clicked no more than 30 seconds after ‘offline’ Sender comes back ‘online’.

### Test_06: Identify which Receiver devices are controllable via IS-05
#### Description
Some of the discovered Receivers are controllable via IS-05, for instance, allowing Senders to be connected. 
* The Testing Tool registers additional Receivers with the mock Registry, a subset of which have a connection API.
* The Test User refreshes the NCuT and selects the Receivers that have a connection API from the provided list.
* Some NCuTs only display those Receivers which have a connection API, therefore some of the Receivers in the provided list may not be visible.

#### User Action
* Select all the Receivers from the provided list that have an IS-05 Connection API (multiple choice checkboxes).

#### Pass Criteria
* All the Receivers with IS-05 Connection APIs are selected.

### Test_07: Instruct Receiver to subscribe to a Sender’s Flow via IS-05
#### Description
All flows that are available in a Sender should be able to be connected to a Receiver.
* The Test User is prompted to perform an immediate activation between a specified Sender and Receiver.

#### User Action
* Perform an 'immediate' activation between the Sender and Receiver indicated.
* Click the 'Next' button once the connection is active.

#### Pass Criteria
* The mock Receiver has received the correct IS-05 PATCH request.

### Test_08: Disconnecting a Receiver from a connected Flow via IS-05
#### Description
IS-05 provides a mechanism for removing an active connection through its API. 
The Test User is prompted to perform an immediate deactivation between a specified Sender and Receiver.

#### User Action
* Use the NCuT to deactivate the connection between the Sender and Receiver indicated.
* Click the 'Next' button once the connection has been removed

#### Pass Criteria
* The mock Receiver has received the correct IS-05 PATCH request

### Test_09: Indicating the state of connections via updates received from the IS-04 Query API
#### Description
The NCuT should be able to monitor and update the connection status of all registered Devices. This test seeks to validate the NCuT’s ability to monitor connections that are made between Senders and Receivers outside on the NCuT’s control.
* A connection to a Receiver is activated. 
* The Test User is asked to identify this Receiver.  
* The Test User is asked to identify the Sender connected to the Receiver. 
* A Receiver connection is deactivated in the background by the Testing Tool within the following 60 seconds. 
* As soon as the NCuT detects the Receiver has been deactivated the Test User must press the 'Next' button.
* The button must be pressed within 30 seconds of the Receiver connection being deactivated. This includes any latency between the Receiver connection being deactivated and the NCuT updating.

#### User Action
* Identify the Receiver on which the connection that has just been activated (multiple choice radio button)
* Identify the Sender currently connected to that Receiver
* Click the ‘Next’ button when the Receiver connection deactivates

#### Pass Criteria
* The Receiver on which the connection has been activated is correctly identified
* The connected Sender is correctly identified
* The ‘Next’ button has been clicked no more than 30 seconds after the Receiver connection is deactivated.

### Post Tests Message
#### Description
Once the tests are complete a post tests message is displayed

#### User Action
* Click the ‘Next’ button to finish tests.